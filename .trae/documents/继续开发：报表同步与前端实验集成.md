## 目标
- 将现有能力落地到生产化路径：数据同步、页面实验集成、可观测与交付完善。
- 在不影响现有业务的前提下，迭代式上线，保证可回滚。

## Mongo→Postgres 增量同步
- 建立订单与订单项的同步流水：使用 Mongoose Change Streams 捕获 `orders`、`order_items` 插入和更新。
- 编写 Node 同步 Worker（独立进程）：消费变更事件，做字段映射与幂等写入 Postgres（UPSERT）。
- 提供初始全量回填脚本：按时间窗口批量把历史 Mongo 订单写入 Postgres，标记同步位点。
- 增加失败重试与死信队列（简化可用 Redis 列队）。
- 验证：对比同一天在 Postgres 与 Mongo 的订单计数与总额，允许 0.5% 以内误差。

## 报表查询 API（读取 Postgres）
- 新增只读控制器与路由：`/api/reports/daily-revenue`、`/api/reports/category-sales`、`/api/reports/top-products`。
- 查询分页与过滤（日期范围、分类、关键字），统一返回体与缓存头（ETag/Cache-Control）。
- 权限：管理员查询全部，普通用户仅可查询与自己相关的报表（如个人订单）。

## 前端 A/B 实验集成
- 封装实验 Hook：`useExperiment(key)`，在页面加载时请求 `/api/experiments/assign` 获取变体并自动打点曝光事件。
- 组件示例：`HomeBannerExperiment`（A/B 两套 Banner），按钮点击上报 `click`，下单完成上报 `conversion`。
- 守卫：变体缺失或接口错误时走默认变体 A，并在控制台记录。

## 实验数据面板
- 管理页新增 `ExperimentDashboard`：展示各变体的曝光/点击/转化、转化率、lift、显著性（p 值）。
- 支持按时间范围与事件类型筛选；可导出 CSV。

## Django 服务容器化与健康检查
- 为 `py_analytics` 增加 Dockerfile 与 Compose 服务，端口 `8000`，设置 `ANALYTICS_URL` 环境变量。
- Node 侧在启动时增加对 `ANALYTICS_URL` 的健康探测与熔断（失败回退到本地计算）。

## CI/CD 扩展
- Lint 阶段增加 ESLint/Prettier、Python flake8 基础检查。
- Test 阶段：后端 Jest 单元 + Supertest API 冒烟；前端 Vitest 单元；Python pytest 单元。
- Build 阶段：前端构建产物归档与缓存；后端容器镜像构建占位。
- 环境变量与密钥管理：使用 GitLab Masked Variables，禁止在代码中硬编码。

## 测试计划
- 单元：同步 Worker 映射函数、A/B 变体选择器、显著性计算（本地与远端一致性）。
- 集成：下单→Mongo 写入→同步到 Postgres→报表 API 返回正确；A/B 页面→事件上报→统计面板更新。
- E2E：Playwright 覆盖首页 Banner 实验与下单转化链路。

## 安全与稳定
- 同步 Worker 设置速率限制与重试退避；报表 API 只读与 SQL 注入防护（参数化查询）。
- 记录审计日志（谁在何时查询了报表）；错误告警（接口 5xx 比例、同步失败率）。

## 上线与回滚
- 先灰度开启同步 Worker 在 `staging`，完成数据比对后再切到 `production`。
- 实验开关通过 `status` 字段控制，支持一键暂停；报表 API 与旧路径并行一周。

## 交付物
- 同步 Worker 与全量回填脚本
- Postgres 报表查询控制器与前端页面集成
- A/B 前端 Hook、实验示例组件与管理面板
- Django 容器与健康探测、CI 流水线升级
- 单元/集成/E2E 测试与使用说明